> The aliens attacked our territory and stole our necessary supplies and kept
> them in a secure manner. We can get them back, but it requires a lot of data
> samples. Fortunately, we have some stuff to get back what we need.
> But, are we lucky enough?!

> Author: **[KRyptonZ][author-profile]**

## Making sense of the challenge

### The parameters

At first glance it looks like another RSA challenge, but it's twisted.
We're given a heap of parameters:

![][equation-signup-parameters]

Where g is a generator of a cyclic group, and according to Euler-Fermat's theorem:

![][equation-group-order]

So the group generated by g is of order q.

Next, the app generates keys for the encryption:

![][equation-signup-keys]

`x` is the private key and `y` the public key.

### A troll?

Btw, since we're all about coding flaws here:

```python
while r == 0:
    r = pow(g, k, p) % q
```

```python
while s == 0:
    Hm = int(sha512(message.encode('utf-8')).hexdigest(), 16)
    s = (inverse(k, q) * (Hm + private_key*r)) % q
```

There are no updates between iterations, ie it'll loop forever if you're unlucky.
**But** it is highly unlikely and also all powers of g are non null (mod q), so
this mistake won't actually trigger in reality.

IDK to what extent the author is trolling, and he's only getting started!

### The signing process

And the signing process is:

![][equation-message-signing]

Where m is the message encoded as an integer and (r, s) the resulting signature.

It can be verified with the public key:

![][equation-signature-verification]

When the signature is valid:

![][equation-valid-signature]

### The known values and the target

Out of all the values mentioned earlier, the only unknown is `x`, the private key.
Shock.

And the flag is simply a byte string xorred with x. So the goal is to find x to
decrypt the flag.

Also, we're showered with messages and their corresponding signatures, 100 of them.
There must be some use to these, so we extract all the values from the output file:

```bash
MESSAGES=$(perl -ne 'm#message\s*:\s*([A-Z0-9]+)#g && print "\"$1\"".", "' output.txt)
SIGNATURES=$(perl -ne 'm#signature\s*:\s*(\(\d+, \d+\))#g && print $1.", "' output.txt)
echo "MESSAGES = [${MESSAGES}]" >> decrypt.py
echo "SIGNATURES = [${SIGNATURES}]" >> decrypt.py
```

## Discrete logarithm attack?

Essentially, the unknown x is the g-logarithm of y. Finding such logarithm has
driven a [lot of research][dlp-article]:

- Baby-Step Giant-Step algorithm
- The Pollard's rho algorithm
- Index calculus
- Pohlig-Hellman algorithm
- and many others...

Looking at the list of messages remainded me of the Chinese remainder theorem,
hence the "index calculus" algorithm. Still it didn't quite match.

Also the first step of the Pollard's algorithm is verified with each signature:

![][equation-pollard-u-v]

So the problem could be reframed as finding one of the k. Still a DLP though.

## Exploiting a mistake

Digging into the DLP, I couldn't find any use for the signatures since they each
introduce a new unknown logarithm.

Still I hadn't performed any verification, and the sheer number of signatures made
me think of random luck, like having two exponents equal:

```python
# 100
len([s[0] for s in SIGNATURES])
# 99
len(set([s[0] for s in SIGNATURES]))
```

I feel scammed! That's a ton of math for an unrelated error, and I almost missed
this thinking "there's no way"...

Anyway, the solution is now obvious:

![][equation-exploiting-duplicate]

The equality of the exponents comes from the fact that q is prime. Also, x, k<sub>29</sub>, k<sub>74</sub>
are all strictly lower than q: there's no multiple of q involved, this is a
straightforward equality.

```python
R = SIGNATURES[29][0]
W1 = pow(SIGNATURES[29][1], -1, Q)
W2 = pow(SIGNATURES[74][1], -1, Q)
H1 = digest(MESSAGES[29])
H2 = digest(MESSAGES[74])

x = (pow(R, -1, Q) * pow(W2 - W1, -1, Q) % Q) * ((W1 * H1 % Q) - (W2 * H2 % Q)) % Q
flag = xor(CTF, bytes.fromhex(hex(x)[2:]))
```

Yup you also read all my BS for a two-liner solution!

> HTB{Sh4r3d_K_1s_n0t_A_g00d_S1gninG_Id3a}

[author-profile]: https://app.hackthebox.eu/users/372989
[dlp-article]: http://shrek.unideb.hu/~tengely/crypto/section-6.html

[equation-exploiting-duplicate]: images/equations/exploiting-duplicate.png
[equation-group-order]: images/equations/group-order.png
[equation-message-signing]: images/equations/message-signing.png
[equation-pollard-u-v]: images/equations/pollard-u-v.png
[equation-signature-verification]: images/equations/signature-verification.png
[equation-signup-keys]: images/equations/signup-keys.png
[equation-signup-parameters]: images/equations/signup-parameters.png
[equation-valid-signature]: images/equations/valid-signature.png
